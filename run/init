#!/bin/bash

set -e
echo $(pwd)

kpath="./kplugin-template"
if [ -e "$kpath" ]
  then
    echo "$kpath"
else
    echo "Should have kplugin-template dir."
    exit 1
fi

bkdir="bk."$(date +"%s")

if [ ! -e "$bkdir" ]
  then
    mkdir $bkdir
fi

mv ./.gitignore "$bkdir"/
cp "$kpath"/.gitignore ./

mv ./package.json "$bkdir"/
cp "$kpath"/package.json ./

mv ./webpack.config.js "$bkdir"/
cp "$kpath"/webpack.config.js ./

mv ./.npmrc "$bkdir"/
cp "$kpath"/.npmrc ./

mv ./README.md "$bkdir"/
cp "$kpath"/README.md ./

# run dir ========================

if [ -e ./run ]
  then
    mv ./run "$bkdir"/
  else
    echo "run dir not found."
fi

mkdir ./run
cp -r "$kpath"/run/watch ./run/
chmod 0755 ./run/watch


if [ -e ./scripts ]
  then
    mv ./scripts "$bkdir"/
  else
    echo "scripts dir not found."
fi

mkdir ./scripts
cp -r "$kpath"/scripts/* ./scripts/


if [ -e ./src ]
  then
    mv ./src "$bkdir"/
  else
    echo "src dir not found."
fi

mkdir ./src
cp -r "$kpath"/src/* ./src/

git init
git submodule update --init --force --remote --recursive
npm install

kintone-plugin-packer src

exit 0
